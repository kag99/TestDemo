import SwiftUI
import RealityKit
import ARKit

struct WatchTryOnView: View {
    // We use a StateObject to keep the AR logic alive and accessible
    @StateObject private var coordinator = WristCoordinator()

    var body: some View {
        RealityView { content in
            // 1. Create the Watch Entity
            if let watch = try? await Entity(named: "AppleWatchSeries11") {
                watch.name = "UserWatch"
                
                // Add Occluder to hide strap behind wrist
                let occluder = Entity()
                occluder.components.set(ModelComponent(
                    mesh: .generateCylinder(height: 0.2, radius: 0.035),
                    materials: [OcclusionMaterial()]
                ))
                occluder.orientation = simd_quatf(angle: .pi/2, axis: [0,0,1])
                watch.addChild(occluder)
                
                content.add(watch)
                coordinator.watchEntity = watch
            }
        }
        // Enable AR Passthrough Camera
        .camera(.spatialTracking) 
        .task {
            await coordinator.startSession()
        }
    }
}

class WristCoordinator: NSObject, ObservableObject, ARSessionDelegate {
    var watchEntity: Entity?
    private let session = ARSession()

    func startSession() async {
        session.delegate = self
        let config = ARBodyTrackingConfiguration()
        // Ensure we are tracking the person for wrist joints
        session.run(config)
    }

    func session(_ session: ARSession, didUpdate anchors: [ARAnchor]) {
        guard let bodyAnchor = anchors.first(where: { $0 is ARBodyAnchor }) as? ARBodyAnchor,
              let watch = watchEntity else { return }

        // Get the skeleton joint for the left wrist
        let skeleton = bodyAnchor.skeleton
        if let wristTransform = skeleton.modelTransform(for: .leftWrist) {
            // Calculate world position: Body Position * Joint Offset
            let worldMatrix = bodyAnchor.transform * wristTransform
            watch.setTransformMatrix(worldMatrix, relativeTo: nil)
            
            // Adjust for surface placement (don't bury it in the arm)
            watch.position.y += 0.02 
        }
    }
}
