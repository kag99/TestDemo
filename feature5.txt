import SwiftUI
import RealityKit
import ARKit

struct WristTrackerView: UIViewRepresentable {
    func makeUIView(context: Context) -> ARView {
        let arView = ARView(frame: .zero)
        
        // 1. Start Body Tracking Configuration
        let config = ARBodyTrackingConfiguration()
        arView.session.run(config)
        
        context.coordinator.arView = arView
        arView.session.delegate = context.coordinator
        
        // 2. Load and prepare the Watch Model
        if let watch = try? Entity.loadModel(named: "AppleWatch") {
            watch.name = "UserWatch"
            
            // Create a simple Occlusion Cylinder to hide the strap behind the wrist
            let occluder = Entity()
            let mesh = MeshResource.generateCylinder(height: 0.2, radius: 0.03)
            occluder.components.set(ModelComponent(mesh: mesh, materials: [OcclusionMaterial()]))
            occluder.orientation = simd_quatf(angle: .pi/2, axis: [0,0,1])
            
            watch.addChild(occluder)
            
            // Add to a world anchor (we will move it manually)
            let worldAnchor = AnchorEntity(world: .zero)
            worldAnchor.addChild(watch)
            arView.scene.addAnchor(worldAnchor)
        }
        
        return arView
    }

    func makeCoordinator() -> Coordinator { Coordinator() }

    class Coordinator: NSObject, ARSessionDelegate {
        weak var arView: ARView?

        func session(_ session: ARSession, didUpdate anchors: [ARAnchor]) {
            for anchor in anchors {
                // Look for the Body Anchor
                guard let bodyAnchor = anchor as? ARBodyAnchor,
                      let watch = arView?.scene.findEntity(named: "UserWatch") else { continue }
                
                // Get the Wrist Joint Transform (index 60-70 typically, use named joints for safety)
                let skeleton = bodyAnchor.skeleton
                if let wristTransform = skeleton.modelTransform(for: .leftWrist) {
                    
                    // Convert local body coordinates to world coordinates
                    let worldTransform = bodyAnchor.transform * wristTransform
                    watch.setTransformMatrix(worldTransform, relativeTo: nil)
                    
                    // Subtle correction: Lift the watch so it sits on top of the wrist
                    watch.position.y += 0.02 
                }
            }
        }
    }
    
    func updateUIView(_ uiView: ARView, context: Context) {}
}
