import SwiftUI
import RealityKit
import ARKit

struct WristWatchView: View {
    var body: some View {
        // The RealityView initializer gives us access to the 'content' 
        // and a 'placeholder' for updates.
        RealityView { content, attachments in
            // 1. Create a root entity to hold our watch
            let rootEntity = Entity()
            rootEntity.name = "WatchRoot"
            
            // 2. Load the USDZ Model
            if let watchModel = try? await Entity(contentsOf: Bundle.main.url(forResource: "AppleWatch", withExtension: "usdz")!) {
                watchModel.name = "WatchModel"
                
                // 3. Add an Occluder (Cylinder) to hide the back strap
                let occluder = Entity()
                let mesh = MeshResource.generateCylinder(height: 0.2, radius: 0.035)
                occluder.components.set(ModelComponent(mesh: mesh, materials: [OcclusionMaterial()]))
                occluder.orientation = simd_quatf(angle: .pi/2, axis: [0,0,1])
                
                watchModel.addChild(occluder)
                rootEntity.addChild(watchModel)
            }
            
            content.add(rootEntity)
            
        } update: { content, attachments in
            // This closure runs when state changes, but for 60fps tracking, 
            // we use the ARSessionDelegate below.
        }
        .task {
            // Start the AR Session for Body Tracking
            await startARSession()
        }
    }

    // MARK: - ARKit Logic
    private func startARSession() async {
        let session = ARSession()
        let delegate = WristCoordinator()
        session.delegate = delegate
        
        let config = ARBodyTrackingConfiguration()
        session.run(config)
    }
}

// 4. The Coordinator handles the "Math" of moving the watch to the wrist
class WristCoordinator: NSObject, ARSessionDelegate {
    var watchEntity: Entity?

    func session(_ session: ARSession, didUpdate anchors: [ARAnchor]) {
        for anchor in anchors {
            guard let bodyAnchor = anchor as? ARBodyAnchor else { continue }
            
            // Access the skeleton provided by ARKit
            let skeleton = bodyAnchor.skeleton
            
            // Get the wrist transform relative to the body's center
            if let wristTransform = skeleton.modelTransform(for: .leftWrist) {
                
                // Combine body position in world space with wrist position in body space
                let worldTransform = bodyAnchor.transform * wristTransform
                
                // Apply to our RealityKit Entity
                // (In a real app, you'd find this entity via a Scene query or Reference)
                watchEntity?.setTransformMatrix(worldTransform, relativeTo: nil)
            }
        }
    }
}
